<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Containers and Persistence :: Build a Container Workshop</title>
    <link rel="canonical" href="https://hatmarch.github.io/container-workshop/intro-container-workshop/1.0/container-persistence.html">
    <link rel="prev" href="podman-intro.html">
    <link rel="next" href="containers-and-security.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://hatmarch.github.io/container-workshop">Build a Container Workshop</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="intro-container-workshop" data-version="1.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Build a Container Workshop</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="introduction.html">Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="introduction.html#open_code_server">Code Server</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="introduction.html#open_code_server_terminal">Open terminal</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="introduction.html#open_code_server_terminal_commands">Issuing Terminal Commands</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="introduction.html#local_browser">Local Browser</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="podman-intro.html">Running Containers</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="podman-intro.html#run_container">Add a website</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="podman-intro.html#enter_container">Look inside a container</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="podman-intro.html#copy_data">Copying data out</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="podman-intro.html#committing_containers">Committing Containers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="podman-intro.html#stop_container">Stopping Containers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="podman-intro.html#remove_containers">Removing Containers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="podman-intro.html#rerunning_container">"Re-running" Containers</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="container-persistence.html">Persistence and Containers</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#mounting_volumes">Mounting Volumes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#test_mount">Testing the Volume Mount</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#tcontainerized_databases">Containerized Databases</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Building Securely</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="containers-and-security.html">Container Security</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="containers-and-security.html#scanning_containers">Scanning Containers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="build-your-own-container.html">Build your own Secure Container</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Scaling and Deploying Containers</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="compose-container.html">Multi containers with Podman</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="deploy-container.html">Containers and OpenShift</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Build a Container Workshop</span>
    <span class="version">1.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Build a Container Workshop</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">1.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Build a Container Workshop</a></li>
    <li><a href="container-persistence.html">Persistence and Containers</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/hatmarch/container-workshop/edit/master/documentation/modules/ROOT/pages/container-persistence.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Containers and Persistence</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><em>10 MINUTE EXERCISE</em></p>
</div>
<div class="paragraph">
<p>Containers are meant to be run as "immutable" instances that exactly match the state of the image that they were started from (as we saw in the last section).  However, there many scenarios where adjusting this otherwise immutable state would be useful such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Having the containers running the same image run differently in different environments (e.g. Preproduction vs Production environments)</p>
<div class="ulist">
<ul>
<li>
<p>For instance, having applications in the container consume different configuration data based on the environment</p>
</li>
</ul>
</div>
</li>
<li>
<p>Persisting state beyond the life of the container (e.g. Databases, logfiles)</p>
</li>
<li>
<p>Sharing state between containers</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Luckily, containers have facilities to support all these things.  We&#8217;ll explore some of these features in this section</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mounting_volumes"><a class="anchor" href="#mounting_volumes"></a>Mounting Volumes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Whilst containers have their own immutable filesystem, it is possible for containers to "mount" volumes that are outside the container&#8217;s filesystem.  This opens up opportunities for persisting state on those mounted filesystems or sharing that state with processes outside the container.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This can also open a number of security concerns for our containers as we&#8217;ll see later on!</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Going back to our website, let&#8217;s see how we can run our webserver in such a way that we can persist our visitor_info.txt.  Our strategy will be to have the container write to a file that is <strong>local to our VM filesystem</strong> instead of into the container&#8217;s filesystem.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>First, let&#8217;s remove (and stop) any container that we might have running (such as the container based on <code>container-workshop-commit</code>):</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">podman rm -a \
    --force <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is a bit of a violent way to stop and remove a running container.  It&#8217;s a little bit like using <code>kill -9</code> to stop a linux process.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Since we&#8217;re going to use the VM&#8217;s filesystem for persistence, we don&#8217;t need to use our committed image (<code>container-workshop-commit</code>) anymore, especially now that we&#8217;ve copied off of it the <code>visitor_info.txt</code> we&#8217;d like to use.  Let&#8217;s remove that image from our machine<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup></p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">podman rmi \<i class="conum" data-value="1"></i><b>(1)</b>
   localhost/container-workshop-commit <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>rmi</code> stands for <em>remove image</em>.  Don&#8217;t confuse this with <code>rm</code> which has to do with removing containers that are stopped</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We&#8217;re removing based on the image name.  We could also remove by <code>IMAGE ID</code></td>
</tr>
</table>
</div>
</li>
<li>
<p>If the command worked, you should see output like the following:</p>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Untagged: localhost/container-workshop-commit:latest
Deleted: f154f395c55ed7192f180502495b96cb3c223d9ce50273cda41bb63e272be7d8</code></pre>
</div>
</div>
</li>
<li>
<p>Next, we&#8217;ll <span id="podman_run_httpd">run</span> our initial <code>quay.io/mhildenb/container-workshop-httpd:0.0.5</code> image, but this time with an additional <code>-v</code> option</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">podman run \
    --privileged \
    -d \
    -p 8081:80/tcp \
    --name my-web-server \
    -v /home/%USER%/container-workshop:/var/log/www:Z \<i class="conum" data-value="1"></i><b>(1)</b>
    quay.io/mhildenb/container-workshop-httpd:0.0.5</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The format of the volume mount option is &lt;host_path&gt;:&lt;container_path&gt;:&lt;options&gt;.  In our case, we&#8217;re mounting <code>/home/%USER%/container-workshop</code> at <code>/var/log/www</code> in the container.  The <code>Z</code> option is for SELinux it tells podman to relabel the volume&#8217;s content to match the label inside the container</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="test_mount"><a class="anchor" href="#test_mount"></a>Testing the Volume Mount</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that the container is running mounted to the <code>/home/%USER%/container-workshop</code> on the host, we should be able to test out its effects</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure you have the <code>visitor_info.txt</code> open in VSCode in an editor pane adject to the <strong>Browser Preview</strong> pane as shown</p>
<div class="imageblock">
<div class="content">
<img src="_images/mounted-visitor-info-setup.png" alt="mounted visitor info setup">
</div>
</div>
</li>
<li>
<p>Next, navigate to the guestbook URL by navigating pasting this in the <strong>Browser Preview</strong></p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code>localhost:8081/hello.html</code></pre>
</div>
</div>
</li>
<li>
<p>Once there, enter a name (such as <em>Danny</em>) into the name field and press Submit</p>
</li>
<li>
<p>You should now see <em>Danny</em> (or whatever name you entered) added to the <code>visitor_info.txt</code> on the host in real time</p>
<div class="imageblock">
<div class="content">
<img src="_images/mounted-visitor-info.png" alt="mounted visitor info">
</div>
<div class="title">Figure 1. See visitors on the host</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="containerized_databases"><a class="anchor" href="#containerized_databases"></a>Containerized Databases</h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This section is not yet completed</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Given that containers have the ability to mount other (persistent) filesystems, database servers also become candidates for running in containers.  (Non ephemeral) containerized databases use volume mounts for their <code>data</code> directory where they write and persist the contents of the database to the filesystem.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Start your database by running the following command:</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">podman run \
    --rm <i class="conum" data-value="1"></i><b>(1)</b>
    --name mysql_database <i class="conum" data-value="2"></i><b>(2)</b>
    -e MYSQL_USER=user -e MYSQL_PASSWORD=pass -e MYSQL_DATABASE=db <i class="conum" data-value="3"></i><b>(3)</b>
    -p 3306:3306
    quay.io/mhildenb/mysql-80</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This means the container should be removed once stopped</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Instead of referring to the container by its <code>Container ID</code> we can provide a name by which we&#8217;d like to address the container</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>These are environment variables that we would like to be made available within the container.  In this instance, these are all environment variables that MySQL uses to set itself up</td>
</tr>
</table>
</div>
</li>
<li>
<p>The terminal should be taken over with log output from the container.  This is because we did not run the container in "daemon mode" and instead it is running in the foreground of our terminal.</p>
</li>
<li>
<p>Open a second terminal to the side by hitting the terminal split button</p>
<div class="imageblock">
<div class="content">
<img src="_images/terminal-split.png" alt="terminal split">
</div>
<div class="title">Figure 2. Terminal split button</div>
</div>
</li>
<li>
<p>Observe the running container image by running the <code>podman ps</code> command</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">podman ps</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">CONTAINER ID  IMAGE                             COMMAND               CREATED         STATUS             PORTS                   NAMES
e658d0e1d5c1  quay.io/mhildenb/mysql-80:latest  run-mysqld --defa...  13 minutes ago  Up 13 minutes ago  0.0.0.0:3306-&gt;3306/tcp  mysql_database <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Notice that this is the name we assigned the container above</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_create_database"><a class="anchor" href="#_create_database"></a>Create Database</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Let&#8217;s create our database providing the output of a .sql file to a mysql cli that is running in the container.  To do this we will use the <code>podman exec</code> command</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat /home/%USER%/container-workshop/sql/example_database.sql | \<i class="conum" data-value="1"></i><b>(1)</b>
    podman exec \<i class="conum" data-value="2"></i><b>(2)</b>
    -i \<i class="conum" data-value="3"></i><b>(3)</b>
    mysql_database \<i class="conum" data-value="4"></i><b>(4)</b>
    mysql -u user -p'pass' -D db <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>output the contents of the .sql file that creates the example database to STDIN</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Run a command in a (running) container</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>interactive: makes STDIN available to whatever command we are exec&#8217;ing</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The name (or <code>Container ID</code>) of the running container where we want to run the command</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The command that we mean to run</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. You can keep images around if you&#8217;d like, but like VM snapshots they take of space on the host filesystem.  Generally it&#8217;s good practice to remove images from your system that you are no longer using
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="podman-intro.html" class="query-params-link">Running Containers</a></span>
  <span class="next"><a href="containers-and-security.html" class="query-params-link">Container Security</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
